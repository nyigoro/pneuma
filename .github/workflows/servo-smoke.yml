name: week8-servo-smoke

on:
  workflow_dispatch:

concurrency:
  group: servo-live-endpoints
  cancel-in-progress: false

jobs:
  servo-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust 1.82.0
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - name: Check Servo endpoint secret
        run: |
          if [ -z "$SERVO_WEBDRIVER_URL" ]; then
            echo "::error::SERVO_WEBDRIVER_URL secret is not set."
            echo "::error::Go to Settings > Secrets > Actions and add SERVO_WEBDRIVER_URL."
            exit 1
          fi
          echo "Servo endpoint: $SERVO_WEBDRIVER_URL"
        env:
          SERVO_WEBDRIVER_URL: ${{ secrets.SERVO_WEBDRIVER_URL }}

      - name: Run Servo smoke test
        run: |
          cargo test -p pneuma-core --test week7_servo_smoke \
            -- --ignored --nocapture 2>&1 | tee week8-servo-smoke.log
        env:
          SERVO_WEBDRIVER_URL: ${{ secrets.SERVO_WEBDRIVER_URL }}
          RUST_LOG: "pneuma=info,pneuma_broker=info,pneuma_js=info,pneuma_engines=debug,ghost_shim=info"
          PNEUMA_LOG: "pneuma=info,pneuma_broker=info,pneuma_js=info,pneuma_engines=debug,ghost_shim=info"

      - name: Upload smoke log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: week8-servo-smoke.log
          path: week8-servo-smoke.log
          retention-days: 7

  week12-escalation-smoke:
    name: Week 12 - Escalation Smoke (Two-Engine)
    runs-on: ubuntu-latest
    needs: servo-smoke

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.82.0

      - name: Verify required secrets are present
        run: |
          if [ -z "$SERVO_WEBDRIVER_URL" ]; then
            echo "::error::SERVO_WEBDRIVER_URL is not set"
            exit 1
          fi
          if [ -z "$SERVO_SECONDARY_WEBDRIVER_URL" ]; then
            echo "::error::SERVO_SECONDARY_WEBDRIVER_URL is not set"
            exit 1
          fi
        env:
          SERVO_WEBDRIVER_URL: ${{ secrets.SERVO_WEBDRIVER_URL }}
          SERVO_SECONDARY_WEBDRIVER_URL: ${{ secrets.SERVO_SECONDARY_WEBDRIVER_URL }}

      - name: Wait for endpoints to report ready
        run: |
          check_ready() {
            local name="$1"
            local base_url="$2"
            for i in $(seq 1 30); do
              body="$(curl -fsS "${base_url}/status" || true)"
              echo "${name} status[${i}]: ${body}"
              if echo "$body" | grep -q '"ready":true'; then
                return 0
              fi
              sleep 2
            done
            echo "::error::${name} endpoint did not report ready:true within timeout."
            echo "::error::URL=${base_url} (verify tunnel is alive and no active stuck session exists)."
            return 1
          }

          check_ready "primary" "$SERVO_WEBDRIVER_URL"
          check_ready "secondary" "$SERVO_SECONDARY_WEBDRIVER_URL"
        env:
          SERVO_WEBDRIVER_URL: ${{ secrets.SERVO_WEBDRIVER_URL }}
          SERVO_SECONDARY_WEBDRIVER_URL: ${{ secrets.SERVO_SECONDARY_WEBDRIVER_URL }}

      - name: Run Week 12 escalation smoke test
        run: |
          cargo test -p pneuma-core --test week12_escalation_smoke \
            -- --ignored --nocapture 2>&1 | tee week12-escalation-smoke.log
        env:
          SERVO_WEBDRIVER_URL: ${{ secrets.SERVO_WEBDRIVER_URL }}
          SERVO_SECONDARY_WEBDRIVER_URL: ${{ secrets.SERVO_SECONDARY_WEBDRIVER_URL }}
          PNEUMA_LOG: pneuma=debug,pneuma_broker=debug,pneuma_engines=debug
          RUST_LOG: pneuma=debug

      - name: Upload smoke log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: week12-escalation-smoke-log
          path: week12-escalation-smoke.log
          retention-days: 14
